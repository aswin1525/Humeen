"use client";

import { useState } from "react";
import { CheckCircle, XCircle, AlertTriangle } from "lucide-react";
import MissionLayout from "../MissionLayout";

export default function MissionSecurity1Vulnerability({ onComplete }: { onComplete: () => void }) {
    const [selectedLine, setSelectedLine] = useState<number | null>(null);
    const [isCorrect, setIsCorrect] = useState<boolean | null>(null);
    const [quizAnswer, setQuizAnswer] = useState<string | null>(null);
    const [quizResult, setQuizResult] = useState<boolean | null>(null);

    const codeLines = [
        { id: 1, text: 'const userId = req.params.id;' },
        { id: 2, text: 'const query = "SELECT * FROM users WHERE id = " + userId;' },
        { id: 3, text: 'db.execute(query, (err, result) => {' },
        { id: 4, text: '  if (err) throw err;' },
        { id: 5, text: '  res.json(result);' },
        { id: 6, text: '});' },
    ];

    const handleSubmit = () => {
        if (selectedLine === 2) {
            setIsCorrect(true);
        } else {
            setIsCorrect(false);
        }
    };

    const handleQuizSubmit = () => {
        if (quizAnswer === "b") {
            setQuizResult(true);
        } else {
            setQuizResult(false);
        }
    };

    const description = (
        <div className="space-y-4">
            <p className="text-lg text-gray-300">
                SQL Injection (SQLi) is a web security vulnerability that allows an attacker to interfere with the queries that an application makes to its database.
            </p>
            <p className="text-gray-400">
                It generally allows an attacker to view data that they are not normally able to retrieve. This might include data belonging to other users, or any other data that the application itself is able to access. In many cases, an attacker can modify or delete this data, causing persistent changes to the application's content or behavior.
            </p>
        </div>
    );

    const realWorldCases = (
        <div className="space-y-4">
            <div className="bg-red-500/10 border border-red-500/20 p-4 rounded-lg">
                <h4 className="font-bold text-red-400 mb-2">The 2011 Sony Pictures Hack</h4>
                <p className="text-sm text-gray-400">
                    Attackers used a simple SQL injection against Sony's website to steal the personal details of over 1 million users. The attack was estimated to cost Sony over $170 million.
                </p>
            </div>
            <div className="bg-orange-500/10 border border-orange-500/20 p-4 rounded-lg">
                <h4 className="font-bold text-orange-400 mb-2">Heartland Payment Systems</h4>
                <p className="text-sm text-gray-400">
                    In 2008, attackers used SQL injection to install spyware on Heartland's payment processing system, compromising 130 million credit card numbers.
                </p>
            </div>
        </div>
    );

    const protection = (
        <div className="space-y-4">
            <h3 className="text-xl font-bold text-green-400">How to Prevent SQL Injection</h3>
            <ul className="list-disc pl-5 space-y-2 text-gray-300">
                <li>
                    <strong className="text-white">Use Prepared Statements (Parameterized Queries):</strong> This is the most effective defense. Instead of concatenating strings, use placeholders (e.g., `?` or `$1`) and let the database engine handle the inputs safely.
                </li>
                <li>
                    <strong className="text-white">Input Validation:</strong> Ensure that input conforms to expected formats (e.g., ensuring an ID is a number).
                </li>
                <li>
                    <strong className="text-white">Principle of Least Privilege:</strong> Ensure the database user used by the application only has the permissions necessary for its function.
                </li>
            </ul>
        </div>
    );

    const tryYourself = (
        <div className="flex flex-col items-center gap-8 w-full max-w-2xl mx-auto">
            <div className="text-center">
                <h3 className="text-xl font-bold text-red-400 mb-2 flex items-center justify-center gap-2">
                    <AlertTriangle className="w-6 h-6" /> SQL Injection Detected
                </h3>
                <p className="text-gray-400">Select the line of code that makes this vulnerable to SQL Injection.</p>
            </div>

            <div className="w-full bg-gray-900 rounded-xl border border-white/10 overflow-hidden font-mono text-sm">
                {codeLines.map((line) => (
                    <div
                        key={line.id}
                        onClick={() => {
                            setSelectedLine(line.id);
                            setIsCorrect(null);
                        }}
                        className={`flex cursor-pointer transition-colors ${selectedLine === line.id
                            ? "bg-red-500/20 text-white"
                            : "hover:bg-white/5 text-gray-400"
                            }`}
                    >
                        <div className="w-8 py-2 text-right pr-3 text-gray-600 select-none border-r border-white/5 bg-black/20">
                            {line.id}
                        </div>
                        <div className="flex-1 py-2 pl-4">
                            {line.text}
                        </div>
                    </div>
                ))}
            </div>

            <button
                onClick={handleSubmit}
                disabled={selectedLine === null}
                className="px-8 py-3 bg-red-600 hover:bg-red-500 text-white rounded-full font-bold transition-colors disabled:opacity-50"
            >
                Analyze Code
            </button>

            {isCorrect === true && (
                <div className="animate-in fade-in slide-in-from-bottom-4 flex flex-col items-center gap-4">
                    <div className="flex items-center gap-2 text-green-400 font-bold text-lg">
                        <CheckCircle className="w-6 h-6" /> Correct! String concatenation allows SQL Injection.
                    </div>
                    <button
                        onClick={onComplete}
                        className="px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full font-bold text-white shadow-lg hover:shadow-green-500/25 transition-all hover:scale-105"
                    >
                        Complete Mission
                    </button>
                </div>
            )}

            {isCorrect === false && (
                <div className="animate-in fade-in slide-in-from-bottom-4 flex items-center gap-2 text-red-400 font-bold">
                    <XCircle className="w-6 h-6" /> Incorrect. Look for where user input is directly mixed with SQL.
                </div>
            )}
        </div>
    );

    const quiz = (
        <div className="max-w-2xl mx-auto">
            <h3 className="text-xl font-bold text-white mb-6">Test Your Knowledge</h3>
            <div className="bg-white/5 p-6 rounded-xl border border-white/10">
                <p className="text-lg mb-4">Which of the following is the BEST way to prevent SQL Injection?</p>
                <div className="space-y-3">
                    <label className="flex items-center gap-3 p-4 rounded-lg bg-black/20 hover:bg-white/5 cursor-pointer transition-colors">
                        <input
                            type="radio"
                            name="quiz"
                            value="a"
                            checked={quizAnswer === "a"}
                            onChange={(e) => setQuizAnswer(e.target.value)}
                            className="w-5 h-5 text-blue-500"
                        />
                        <span>Sanitizing all user input with regex</span>
                    </label>
                    <label className="flex items-center gap-3 p-4 rounded-lg bg-black/20 hover:bg-white/5 cursor-pointer transition-colors">
                        <input
                            type="radio"
                            name="quiz"
                            value="b"
                            checked={quizAnswer === "b"}
                            onChange={(e) => setQuizAnswer(e.target.value)}
                            className="w-5 h-5 text-blue-500"
                        />
                        <span>Using Parameterized Queries (Prepared Statements)</span>
                    </label>
                    <label className="flex items-center gap-3 p-4 rounded-lg bg-black/20 hover:bg-white/5 cursor-pointer transition-colors">
                        <input
                            type="radio"
                            name="quiz"
                            value="c"
                            checked={quizAnswer === "c"}
                            onChange={(e) => setQuizAnswer(e.target.value)}
                            className="w-5 h-5 text-blue-500"
                        />
                        <span>Encrypting the database</span>
                    </label>
                </div>

                <div className="mt-6 flex items-center gap-4">
                    <button
                        onClick={handleQuizSubmit}
                        disabled={!quizAnswer}
                        className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold disabled:opacity-50 transition-colors"
                    >
                        Submit Answer
                    </button>

                    {quizResult === true && (
                        <span className="text-green-400 font-bold flex items-center gap-2">
                            <CheckCircle className="w-5 h-5" /> Correct!
                        </span>
                    )}

                    {quizResult === false && (
                        <span className="text-red-400 font-bold flex items-center gap-2">
                            <XCircle className="w-5 h-5" /> Incorrect, try again.
                        </span>
                    )}
                </div>
            </div>
        </div>
    );

    return (
        <MissionLayout
            title="SQL Injection Vulnerability"
            description={description}
            realWorldCases={realWorldCases}
            protection={protection}
            tryYourself={tryYourself}
            quiz={quiz}
            onComplete={onComplete}
        />
    );
}
